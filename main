import pickle
from tkinter import Tk
from tkinter.filedialog import askopenfilename
from class_function import *
from sklearn.metrics import classification_report

# landing page
print("=" * 40)
print(" Employee Turnover Prediction - Version April 2024")
print(" Please wait before selecting your file")
print("=" * 40)
print()

def predict_attrition(config=None, model=None):
    if config is None:
        Tk().withdraw()  # we don't want a full GUI, so keep the root window from appearing
        filename = askopenfilename()  # show an "Open" dialog box and return the path to the selected file
        print("Loading file: " + filename)
        attrition_df_temp = pd.read_csv(filename)
        config = attrition_df_temp.copy()

    if model is None:
        with open('D:/forest_model.bin', 'rb') as file:
            model = pickle.load(file)
            file.close()

    print(attrition_df_temp)
    data_temp_dropped_X = attrition_df_temp[
        ["Age",
         "YearsWithCurrManager",
         "JobInvolvement",
         "YearsSinceLastPromotion",
         "JobRole",
         "Gender",
         "TotalWorkingYears",
         "NumCompaniesWorked",
         "PerformanceRating",
         "YearsInCurrentRole"]].copy()
    data_temp_dropped_X = pipeline_transformer(data_temp_dropped_X)
    y_pred = model.predict(data_temp_dropped_X)

    # Calculate percentage of 'Yes' predictions
    yes_count = sum(1 for prediction in y_pred if prediction == 'Yes')
    total_count = len(y_pred)
    percentage_yes = (yes_count / total_count) * 100
    print("-" * 40)
    print("Attrition Prediction:")
    print(f"Prediction - Employee at risk of resignations: {percentage_yes:.2f}%")
    print(f"Total predicted at risk: {yes_count} people")
    print("-" * 40)

    # Feature Importance Analysis
    if hasattr(model, 'feature_importances_'):
        feature_importance = model.feature_importances_
        # Assuming you keep track of feature names separately
        feature_names = ["Age", "YearsWithCurrManager", "JobInvolvement", "YearsSinceLastPromotion",
                         "JobRole", "Gender", "TotalWorkingYears", "NumCompaniesWorked",
                         "PerformanceRating", "YearsInCurrentRole"]
        importance_dict = dict(zip(feature_names, feature_importance))
        sorted_importance = sorted(importance_dict.items(), key=lambda x: x[1], reverse=True)
        print("\nRanking - Top Driving Reasons for Resignations:")
        print("-" * 40)
        for feature, importance in sorted_importance:
            print(f"{feature}: {importance:.4f}")

    return y_pred

# Example usage:
predict_attrition()


